<!-- templates/destinations/package_detail.html -->
{% extends 'base.html' %}

{% block title %}{{ package.name }} | Wanderlust{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/package_detail.css">
{% endblock %}

{% block content %}
<!-- Package Hero -->
<section class="package-hero" style="background-image: url('{{ package.destination.main_image.url }}');">
    <div class="package-hero-content">
        <h1 data-aos="fade-up">{{ package.name }}</h1>
        <p data-aos="fade-up" data-aos-delay="200"><i class="fas fa-map-marker-alt"></i> {{ package.destination.name }},
            {{ package.destination.country.name }}</p>
    </div>
    <div class="package-hero-overlay"></div>
</section>

<!-- Package Overview -->
<section class="package-overview py-4">
    <div class="container">
        <div class="overview-wrapper" data-aos="fade-up">
            <div class="row">
                <div class="col-md-8">
                    <div class="overview-details">
                        <div class="overview-item">
                            <div class="overview-icon">
                                <i class="far fa-calendar-alt"></i>
                            </div>
                            <div class="overview-text">
                                <span>Duration</span>
                                <strong>{{ package.duration }} Days</strong>
                            </div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="overview-text">
                                <span>Group Size</span>
                                <strong>Max {{ package.group_size }} People</strong>
                            </div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-icon">
                                <i class="fas fa-hiking"></i>
                            </div>
                            <div class="overview-text">
                                <span>Difficulty</span>
                                <strong>{{ package.get_difficulty_display }}</strong>
                            </div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="overview-text">
                                <span>Rating</span>
                                <strong>4.8/5 ({{ package.reviews.count }} reviews)</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="overview-price text-center text-md-end">
                        <div class="price-label">Starting from</div>
                        {% if package.discount_price %}
                        <div class="old-price">${{ package.price }}</div>
                        <div class="current-price">${{ package.discount_price }}</div>
                        {% else %}
                        <div class="current-price">${{ package.price }}</div>
                        {% endif %}
                        <div class="price-unit">per person</div>
                        <a href="{% url 'create_booking' package.slug %}" class="btn btn-primary btn-lg mt-3">Book
                            Now</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Package Content -->
<section class="package-content py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <!-- Description -->
                <div class="package-section" data-aos="fade-up">
                    <h2>About This Tour</h2>
                    <div class="package-description">
                        {{ package.description|linebreaks }}
                    </div>
                </div>

                <!-- Itinerary -->
                <div class="package-section" data-aos="fade-up">
                    <h2>Detailed Itinerary</h2>
                    <div class="itinerary-timeline">
                        {% for day_itinerary in package.itinerary.splitlines %}
                        {% if day_itinerary %}
                        {% with day_parts=day_itinerary.split:':' %}
                        <div class="itinerary-day">
                            <div class="day-header">
                                <div class="day-number">Day {{ forloop.counter }}</div>
                                <h3>{% if day_parts.1 %}{{ day_parts.0 }}{% else %}Day {{ forloop.counter }}{% endif %}
                                </h3>
                            </div>
                            <div class="day-content">
                                <p>{% if day_parts.1 %}{{ day_parts.1 }}{% else %}{{ day_parts.0 }}{% endif %}</p>
                            </div>
                        </div>
                        {% endwith %}
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Inclusions -->
                <div class="package-section" data-aos="fade-up">
                    <h2>What's Included</h2>
                    <div class="included-list">
                        {% for inclusion in package.inclusions.splitlines %}
                        {% if inclusion %}
                        <div class="included-item">
                            <div class="included-icon">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="included-text">{{ inclusion }}</div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Exclusions -->
                <div class="package-section" data-aos="fade-up">
                    <h2>What's Not Included</h2>
                    <div class="excluded-list">
                        {% for exclusion in package.exclusions.splitlines %}
                        {% if exclusion %}
                        <div class="excluded-item">
                            <div class="excluded-icon">
                                <i class="fas fa-times"></i>
                            </div>
                            <div class="excluded-text">{{ exclusion }}</div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>

                <!-- Gallery -->
                <div class="package-section" data-aos="fade-up">
                    <h2>Tour Gallery</h2>
                    <div class="gallery-container" id="packageGallery">
                        {% for image in package.destination.images.all %}
                        <a href="{{ image.image.url }}" class="gallery-item">
                            <img src="{{ image.image.url }}" alt="{{ image.caption|default:package.destination.name }}">
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Reviews -->
                <div class="package-section" data-aos="fade-up">
                    <h2>Traveler Reviews</h2>
                    {% if package.reviews.exists %}
                    <div class="reviews-container">
                        {% for review in package.reviews.filter.is_approved %}
                        <div class="review-card">
                            <div class="review-header">
                                <div class="reviewer-info">
                                    <div class="reviewer-avatar">
                                        <img src="https://ui-avatars.com/api/?name={{ review.user.get_full_name|default:review.user.username }}&background=random"
                                            alt="{{ review.user.username }}">
                                    </div>
                                    <div class="reviewer-name">
                                        <h5>{{ review.user.get_full_name|default:review.user.username }}</h5>
                                        <span class="review-date">{{ review.created_at|date:"F d, Y" }}</span>
                                    </div>
                                </div>
                                <div class="review-rating">
                                    {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %} <i class="fas fa-star"></i>
                                        {% else %}
                                        <i class="far fa-star"></i>
                                        {% endif %}
                                        {% endfor %}
                                </div>
                            </div>
                            <div class="review-content">
                                <h4>{{ review.title }}</h4>
                                <p>{{ review.comment }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-reviews">
                        <p>There are no reviews yet for this package. Be the first to share your experience!</p>
                    </div>
                    {% endif %}

                    {% if user.is_authenticated %}
                    <div class="write-review-btn text-center mt-4">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">Write a
                            Review</button>
                    </div>

                    <!-- Review Modal -->
                    <div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Write a Review for {{ package.name }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form method="post" action="{% url 'add_package_review' package.slug %}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label">Rating</label>
                                            <div class="rating-select">
                                                <div class="stars">
                                                    <input type="radio" name="rating" id="star5" value="5" required>
                                                    <label for="star5"><i class="far fa-star"></i></label>
                                                    <input type="radio" name="rating" id="star4" value="4">
                                                    <label for="star4"><i class="far fa-star"></i></label>
                                                    <input type="radio" name="rating" id="star3" value="3">
                                                    <label for="star3"><i class="far fa-star"></i></label>
                                                    <input type="radio" name="rating" id="star2" value="2">
                                                    <label for="star2"><i class="far fa-star"></i></label>
                                                    <input type="radio" name="rating" id="star1" value="1">
                                                    <label for="star1"><i class="far fa-star"></i></label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reviewTitle" class="form-label">Title</label>
                                            <input type="text" class="form-control" id="reviewTitle" name="title"
                                                required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="reviewComment" class="form-label">Your Review</label>
                                            <textarea class="form-control" id="reviewComment" name="comment" rows="4"
                                                required></textarea>
                                        </div>
                                        <div class="text-end">
                                            <button type="button" class="btn btn-secondary"
                                                data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-primary">Submit Review</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="login-to-review text-center mt-4">
                        <p>Please <a href="#">login</a> to write a review</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Sidebar -->
                <div class="package-sidebar">
                    <!-- Booking Form -->
                    <div class="sidebar-widget booking-widget" data-aos="fade-up">
                        <h3>Book This Tour</h3>
                        <form method="get" action="{% url 'create_booking' package.slug %}" class="booking-form">
                            <div class="mb-3">
                                <label class="form-label">Travel Date</label>
                                <input type="date" class="form-control" name="travel_date" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Number of Travelers</label>
                                <select class="form-select" name="travelers" required>
                                    {% for i in "123456" %}
                                    <option value="{{ forloop.counter }}">{{ forloop.counter }} {% if forloop.counter ==
                                        1 %}Person{% else %}People{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="price-calculation">
                                <div class="price-row">
                                    <span>Base Price:</span>
                                    <span>${{ package.price }} x <span class="traveler-count">1</span></span>
                                </div>
                                {% if package.discount_price %}
                                <div class="price-row discount">
                                    <span>Discount:</span>
                                    <span>-${{ package.discount_amount }} x <span class="traveler-count">1</span></span>
                                </div>
                                {% endif %}
                                <div class="price-row total">
                                    <span>Total:</span>
                                    <span class="total-price">${{ package.price }}</span>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Proceed to Booking</button>
                        </form>
                    </div>

                    <!-- Tour Highlights -->
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3>Tour Highlights</h3>
                        <div class="tour-highlights">
                            <div class="highlight-item">
                                <div class="highlight-icon">
                                    <i class="fas fa-mountain"></i>
                                </div>
                                <div class="highlight-text">Explore stunning natural landscapes</div>
                            </div>
                            <div class="highlight-item">
                                <div class="highlight-icon">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <div class="highlight-text">Taste authentic local cuisine</div>
                            </div>
                            <div class="highlight-item">
                                <div class="highlight-icon">
                                    <i class="fas fa-landmark"></i>
                                </div>
                                <div class="highlight-text">Visit historical landmarks and monuments</div>
                            </div>
                            <div class="highlight-item">
                                <div class="highlight-icon">
                                    <i class="fas fa-hands-helping"></i>
                                </div>
                                <div class="highlight-text">Engage with local communities</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3>Additional Information</h3>
                        <div class="additional-info">
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-language"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Languages</h4>
                                    <p>English, Spanish</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-bed"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Accommodation</h4>
                                    <p>3-4 Star Hotels</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-bus"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Transportation</h4>
                                    <p>Air-conditioned vehicles</p>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-icon">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <div class="info-content">
                                    <h4>Meals</h4>
                                    <p>Breakfast included</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Related Packages -->
                    <div class="sidebar-widget" data-aos="fade-up">
                        <h3>Similar Packages</h3>
                        <div class="related-packages">
                            {% for related in related_packages %}
                            <a href="{% url 'package_detail' related.slug %}" class="related-package-item">
                                <div class="related-package-img">
                                    <img src="{{ related.destination.main_image.url }}" alt="{{ related.name }}">
                                </div>
                                <div class="related-package-info">
                                    <h4>{{ related.name }}</h4>
                                    <div class="related-package-meta">
                                        <span><i class="far fa-calendar-alt"></i> {{ related.duration }} Days</span>
                                        <span>${{ related.price }}</span>
                                    </div>
                                </div>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="/static/js/package_detail.js"></script>
{% endblock %}